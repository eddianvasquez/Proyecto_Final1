@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Proyecto_Final1.Components.Account
@using Proyecto_Final1.Services
@inject NavigationManager NavManager
@inject IdentityRedirectManager RedirectManager
@inject ProductosService ProductosService

<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <NavLink href="/" class="flex items-center space-x-2">
                <i class="fas fa-leaf text-2xl text-green-600"></i>
                <span class="text-xl font-bold text-green-700">Mercado Orgánico</span>
            </NavLink>
        </div>

        <div class="hidden md:flex items-center space-x-6">
            <NavLink href="/" class="text-gray-700 hover:text-green-600 transition-colors" Match="NavLinkMatch.All">Inicio</NavLink>
            <NavLink href="/productos" class="text-gray-700 hover:text-green-600 transition-colors">Productos</NavLink>
            <NavLink href="/nosotros" class="text-gray-700 hover:text-green-600 transition-colors">Nosotros</NavLink>
            <NavLink href="/contacto" class="text-gray-700 hover:text-green-600 transition-colors">Contacto</NavLink>
        </div>

        <div class="relative flex-grow mx-4 max-w-md">
            <input type="text" @bind="searchTerm" @onkeyup="HandleSearch"
                   class="w-full pl-10 pr-12 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500"
                   placeholder="Buscar productos..." />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            @if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                <button @onclick="ClearSearch" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            }
        </div>

        <div class="flex items-center space-x-4">
            <AuthorizeView Roles="Admin">
                <div class="relative">
                    <button @onclick="ToggleAdminMenu" class="text-green-700 hover:text-green-600 focus:outline-none transition-colors p-2">
                        <i class="fas fa-leaf text-xl"></i>
                    </button>
                    @if (showAdminMenu)
                    {
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <NavLink href="/admin/CrearProducto" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Crear Producto
                            </NavLink>
                            <NavLink href="/admin/EditarProducto" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Administrar Productos
                            </NavLink>
                            <NavLink href="/reportes/ventas" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Reporte de Ventas
                            </NavLink>
                            <NavLink href="/Admin/Preguntas" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Administrar Preguntas
                            </NavLink>
                            <NavLink href="/admin/consultas" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Administrar Consulta
                            </NavLink>
                            <NavLink href="/admin/pedidos" @onclick="ToggleAdminMenu" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                Administrar Pedidos
                            </NavLink>
                        </div>
                    }
                </div>
            </AuthorizeView>

            <AuthorizeView>
                <Authorized>
                    <NavLink href="/perfil" class="p-2 text-gray-700 hover:text-green-600 transition-colors">
                        <i class="fas fa-user text-xl"></i>
                    </NavLink>
                    <form action="Account/Logout" method="post" class="inline">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@NavManager.ToBaseRelativePath(NavManager.Uri)" />
                        <button type="submit" class="p-2 text-gray-700 hover:text-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </form>
                </Authorized>
                <NotAuthorized>
                    <NavLink href="/Account/Login" class="p-2 text-gray-700 hover:text-green-600 transition-colors">
                        <i class="fas fa-user text-xl"></i>
                    </NavLink>
                </NotAuthorized>
            </AuthorizeView>

            <NavLink href="/carrito" class="relative p-2 text-gray-700 hover:text-green-600 transition-colors">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-green-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                    @cartCount
                </span>
            </NavLink>

            <button class="md:hidden p-2 text-gray-700 hover:text-green-600 transition-colors" @onclick="ToggleMobileMenu">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </div>

    @if (showMobileMenu)
    {
        <div class="md:hidden bg-white shadow-lg py-4">
            <div class="flex flex-col items-center space-y-4">
                <NavLink href="/" @onclick="ToggleMobileMenu" class="text-gray-700 hover:text-green-600 transition-colors">Inicio</NavLink>
                <NavLink href="/productos" @onclick="ToggleMobileMenu" class="text-gray-700 hover:text-green-600 transition-colors">Productos</NavLink>
                <NavLink href="/nosotros" @onclick="ToggleMobileMenu" class="text-gray-700 hover:text-green-600 transition-colors">Nosotros</NavLink>
                <NavLink href="/contacto" @onclick="ToggleMobileMenu" class="text-gray-700 hover:text-green-600 transition-colors">Contacto</NavLink>
                <div class="relative w-full px-4">
                    <input type="text" @bind="searchTerm" @onkeyup="HandleSearch"
                           class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="Buscar..." />
                    <i class="fas fa-search absolute left-7 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>
    }
</nav>

<div class="page">
    <main>
        <article class="content">
            @Body
        </article>
    </main>
</div>

<footer id="contact" class="bg-gray-800 text-white py-8">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h3 class="text-xl font-bold mb-4">Mercado Orgánico</h3>
                <p class="text-gray-400">Ofreciendo los productos más frescos desde 2010.</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Contacto</h3>
                <p class="text-gray-400 mb-2"><i class="fas fa-map-marker-alt mr-2"></i> Av. Ecológica 123, Ciudad</p>
                <p class="text-gray-400 mb-2"><i class="fas fa-phone mr-2"></i> (123) 456-7890</p>
                <p class="text-gray-400"><i class="fas fa-envelope mr-2"></i> info@mercadoorganico.com</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Horario</h3>
                <p class="text-gray-400 mb-1">Lunes - Viernes: 8am - 8pm</p>
                <p class="text-gray-400 mb-1">Sábado: 9am - 6pm</p>
                <p class="text-gray-400">Domingo: 10am - 4pm</p>
            </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
            <p>© @DateTime.Now.Year Mercado Orgánico. Todos los derechos reservados.</p>
        </div>
    </div>
</footer>

@code {
    private bool showMobileMenu = false;
    private bool showAdminMenu = false;
    private int cartCount = 0;
    private string searchTerm = string.Empty;

    protected override void OnInitialized()
    {
        cartCount = 3;
    }

    private void ToggleMobileMenu()
    {
        showMobileMenu = !showMobileMenu;
    }

    private void ToggleAdminMenu()
    {
        showAdminMenu = !showAdminMenu;
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            // Intenta encontrar una coincidencia exacta por nombre
            var productoEncontrado = await ProductosService.GetProductoByNombreAsync(searchTerm);

            if (productoEncontrado != null)
            {
                // Si hay una coincidencia exacta, redirige a la página de detalles del producto
                NavManager.NavigateTo($"/producto/{productoEncontrado.ProductoId}");
            }
            else
            {
                // Si no hay una coincidencia exacta, redirige a la página de productos con el filtro
                NavManager.NavigateTo($"/productos?q={searchTerm}");
            }
        }
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        NavManager.NavigateTo("/productos");
    }
}